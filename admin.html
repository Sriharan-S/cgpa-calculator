<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #111827; color: #fff; }
        .card { background: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; }
        .input-dark { background: #374151; border: 1px solid #4b5563; color: white; padding: 0.5rem; border-radius: 0.375rem; width: 100%; }
        .btn-red { background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .btn-green { background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
    </style>
</head>
<body class="p-6 max-w-5xl mx-auto pb-20">

    <div id="login-overlay" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-400">Admin Login</h2>
            <input type="password" id="password" placeholder="Enter Admin Password" class="input-dark mb-4 text-center text-lg">
            <button onclick="loadData()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition">Access Dashboard</button>
            <p id="login-msg" class="text-red-400 text-sm mt-4 text-center min-h-[20px]"></p>
        </div>
    </div>

    <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-gray-100">Course Management</h1>
        <div class="flex gap-4">
            <button onclick="addNewSemester()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-medium transition">+ Add Semester</button>
            <button onclick="saveData()" class="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-lg font-bold shadow-lg shadow-emerald-900/50 transition">Save Changes</button>
        </div>
    </div>

    <div id="semesters-container" class="space-y-8"></div>

    <script>
        // CONFIGURATION: Replace with your Worker URL
        const WORKER_URL = "https://sgpa.sriharan2544.workers.dev";
        let courseData = {};

        // --- AUTH & LOAD ---
        async function loadData() {
            const pwd = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            msg.innerText = "Authenticating...";

            try {
                const res = await fetch(WORKER_URL, {
                    method: 'GET',
                    headers: { 'X-Admin-Password': pwd }
                });

                if (res.status === 401) throw new Error("Incorrect Password");
                if (!res.ok) throw new Error("Server Error");

                const data = await res.json();
                
                // Decode content
                const content = decodeURIComponent(escape(window.atob(data.content)));
                courseData = JSON.parse(content);
                
                renderUI();
                document.getElementById('login-overlay').classList.add('hidden');
            } catch (e) {
                msg.innerText = e.message;
            }
        }

        // --- RENDERING UI ---
        function renderUI() {
            const container = document.getElementById('semesters-container');
            container.innerHTML = '';

            // Convert object to array, sort by sem_number, then loop
            Object.keys(courseData).forEach(key => {
                const sem = courseData[key];
                const semDiv = document.createElement('div');
                semDiv.className = "card p-6 relative";
                semDiv.dataset.id = key; // Store original ID

                semDiv.innerHTML = `
                    <button onclick="deleteSemester('${key}')" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6 pr-10">
                        <div class="md:col-span-8">
                            <label class="block text-xs text-gray-400 mb-1">Semester Name</label>
                            <input type="text" value="${sem.name}" class="input-dark font-bold text-lg" onchange="updateSemField('${key}', 'name', this.value)">
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-xs text-gray-400 mb-1">Semester Number</label>
                            <input type="number" value="${sem.sem_number}" class="input-dark" onchange="updateSemField('${key}', 'sem_number', parseInt(this.value))">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-[#111827] p-4 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-indigo-400 font-medium text-sm uppercase tracking-wide">Required Subjects</h3>
                                <button onclick="addSubject('${key}')" class="btn-green">+ Add</button>
                            </div>
                            <div id="req-list-${key}" class="space-y-2">
                                ${Object.entries(sem.required).map(([subName, credits]) => `
                                    <div class="flex gap-2">
                                        <input type="text" placeholder="Subject Name" value="${subName}" class="input-dark flex-grow text-sm" onchange="updateSubjectName('${key}', '${subName}', this.value)">
                                        <input type="number" placeholder="Cr" value="${credits}" class="input-dark w-16 text-center text-sm" onchange="updateSubjectCredit('${key}', '${subName}', this.value)">
                                        <button onclick="deleteSubject('${key}', '${subName}')" class="text-gray-500 hover:text-red-500 p-2">✕</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-[#111827] p-4 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-orange-400 font-medium text-sm uppercase tracking-wide">Electives / Optional</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">Credits:</span>
                                    <input type="number" value="${sem.elective_credit}" class="input-dark w-12 text-center py-1 h-7 text-xs" onchange="updateSemField('${key}', 'elective_credit', parseInt(this.value))">
                                    <button onclick="addOptional('${key}')" class="btn-green ml-2">+ Add</button>
                                </div>
                            </div>
                            <div id="opt-list-${key}" class="space-y-2">
                                ${sem.optional.map((optName, idx) => `
                                    <div class="flex gap-2">
                                        <input type="text" value="${optName}" class="input-dark flex-grow text-sm" onchange="updateOptionalName('${key}', ${idx}, this.value)">
                                        <button onclick="deleteOptional('${key}', ${idx})" class="text-gray-500 hover:text-red-500 p-2">✕</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(semDiv);
            });
        }

        // --- DATA MANIPULATION HANDLERS ---
        
        function updateSemField(id, field, value) {
            courseData[id][field] = value;
        }

        function updateSubjectName(id, oldName, newName) {
            if(oldName === newName) return;
            const credits = courseData[id].required[oldName];
            delete courseData[id].required[oldName];
            courseData[id].required[newName] = credits;
            renderUI(); // Re-render to sort keys or update DOM
        }

        function updateSubjectCredit(id, name, credits) {
            courseData[id].required[name] = parseFloat(credits);
        }

        function deleteSubject(id, name) {
            if(confirm(`Delete ${name}?`)) {
                delete courseData[id].required[name];
                renderUI();
            }
        }

        function addSubject(id) {
            const name = prompt("Enter Subject Name:");
            if(name) {
                courseData[id].required[name] = 3; // Default credit
                renderUI();
            }
        }

        function updateOptionalName(id, idx, value) {
            courseData[id].optional[idx] = value;
        }

        function deleteOptional(id, idx) {
            courseData[id].optional.splice(idx, 1);
            renderUI();
        }

        function addOptional(id) {
            courseData[id].optional.push("New Elective Subject");
            renderUI();
        }

        function addNewSemester() {
            const newId = Date.now().toString(); // Simple unique ID
            courseData[newId] = {
                name: "New Semester",
                sem_number: 0,
                required: {},
                optional: [],
                elective_credit: 0
            };
            renderUI();
        }

        function deleteSemester(id) {
            if(confirm("Are you sure you want to delete this entire semester?")) {
                delete courseData[id];
                renderUI();
            }
        }

        // --- SAVING ---
        async function saveData() {
            const pwd = document.getElementById('password').value;
            const btn = document.querySelector('button[onclick="saveData()"]');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            
            // Encode to Base64 (UTF-8 safe)
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(courseData, null, 2))));

            try {
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Password': pwd
                    },
                    body: JSON.stringify({ content: content })
                });

                if(!res.ok) throw new Error("Save Failed");
                
                alert("Saved successfully!");
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>